# Terraform Provisioning Diagram

Source flow references:
- `provision-db.sh`
- `terraform/provider.tf`
- `terraform/variables.tf`
- `terraform/main.tf`
- `terraform/outputs.tf`
- `terraform/templates/inventory.tpl`

```mermaid
flowchart TD
  A[User runs ./provision-db.sh -e ENV -c CUSTOMER] --> B[Read env/ENV/CUSTOMER/db-config.yml]
  B --> C[Build TF vars + instance name db-postgres-REGION-customer-env]
  C --> D[terraform init -upgrade]
  D --> E{Plan only?}
  E -->|Yes| F[terraform plan]
  E -->|No| G[terraform apply]

  G --> H[google_compute_disk db_data]
  G --> I[google_compute_firewall db_allow_ssh]
  G --> J[google_compute_firewall db_allow_ports_5432]
  G --> K[google_compute_instance db_instance]
  H --> K
  I --> K
  J --> K

  K --> L[remote-exec check over SSH]
  K --> M[Generate local_file ansible/inventory/hosts_ENV_CUSTOMER.yml]
  G --> N[terraform output instance_external_ip]
  N --> O[Run upload-secrets.sh ENV CUSTOMER]
  O --> P[Create or update GCP Secret Manager secrets]
  P --> Q[Next: ./configuration-db.sh -e ENV -c CUSTOMER]
```

```mermaid
flowchart TD
  A[Terraform Provider Setup] --> B[hashicorp/google ~> 5.0]
  A --> C[hashicorp/local ~> 2.0]
  B --> D[provider google: project, region, zone]

  E[Input Variables] --> E1[project_id, region, zone, customer, environment]
  E --> E2[machine_type, boot_disk_size, data_disk_size, image]
  E --> E3[ssh_user, ssh key paths, db_type=postgres]

  F[Locals] --> F1[instance_name=db-postgres-region-customer-env]
  F --> F2[hostname=instance.c.project.internal]

  D --> G[google_compute_firewall db_allow_ssh tcp/22 0.0.0.0/0]
  D --> H[google_compute_firewall db_allow_ports tcp/5432 0.0.0.0/0]
  D --> I[google_compute_disk db_data pd-ssd]
  D --> J[google_compute_instance db_instance]
  I --> J

  J --> J1[boot disk pd-ssd and image]
  J --> J2[attach db_data disk as database-data]
  J --> J3[network default and ephemeral external IP]
  J --> J4[metadata: ssh-keys, env, customer, db-type, role]
  J --> J5[startup script: sudoers, wheel, SELinux permissive]
  J --> J6[labels: environment, customer, db-type, role, managed-by]
  J --> J7[deletion_protection only for prod]
  J --> J8[remote-exec readiness check]
  J --> J9[lifecycle ignore_changes metadata ssh-keys]

  J --> K[local_file ansible inventory from templates/inventory.tpl]
  K --> K1[hosts_ENV_CUSTOMER.yml with ansible_user, key, host, metadata]

  J --> L[Outputs: name, hostname, external and internal IP, ssh command, inventory path]
```

Notes:
- `zone` is passed as input, but instance and data disk currently use `"${var.region}-a"` in `terraform/main.tf`.
- Inventory consumed by scripts is static `hosts_ENV_CUSTOMER.yml` generated by Terraform.
