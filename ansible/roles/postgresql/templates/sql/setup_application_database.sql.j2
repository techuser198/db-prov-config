\set ON_ERROR_STOP on

SELECT format(
  'CREATE DATABASE %I ENCODING ''UTF8'' OWNER postgres',
  '{{ db_name | lower }}'
)
WHERE NOT EXISTS (
  SELECT 1 FROM pg_database WHERE datname = '{{ db_name | lower }}'
)\gexec

DO $$
BEGIN
  IF NOT EXISTS (
    SELECT 1 FROM pg_roles WHERE rolname = '{{ db_name | lower }}_user'
  ) THEN
    EXECUTE format(
      'CREATE USER %I WITH PASSWORD %L',
      '{{ db_name | lower }}_user',
      '{{ db_user_password | replace("'", "''") }}'
    );
    RAISE NOTICE 'USER_CREATED';
  ELSE
    EXECUTE format(
      'ALTER USER %I WITH PASSWORD %L',
      '{{ db_name | lower }}_user',
      '{{ db_user_password | replace("'", "''") }}'
    );
    RAISE NOTICE 'USER_PASSWORD_UPDATED';
  END IF;
END
$$;

DO $$
BEGIN
  IF NOT (
    has_database_privilege('{{ db_name | lower }}_user', '{{ db_name | lower }}', 'CONNECT')
    AND has_database_privilege('{{ db_name | lower }}_user', '{{ db_name | lower }}', 'CREATE')
    AND has_database_privilege('{{ db_name | lower }}_user', '{{ db_name | lower }}', 'TEMPORARY')
  ) THEN
    EXECUTE format(
      'GRANT ALL PRIVILEGES ON DATABASE %I TO %I',
      '{{ db_name | lower }}',
      '{{ db_name | lower }}_user'
    );
    RAISE NOTICE 'PRIVILEGES_GRANTED';
  END IF;
END
$$;
