- name: Validate that secrets are loaded
  assert:
    that:
      - db_master_password is defined
      - db_master_password | length > 0
      - db_user_password is defined
      - db_user_password | length > 0
    fail_msg: "Database passwords not loaded from GCP Secret Manager"
    success_msg: "Database passwords successfully loaded from GCP"

- name: Set PostgreSQL superuser password (using secret from GCP)
  become: yes
  become_user: "{{ pg_user }}"
  postgresql_query:
    db: postgres
    query: "ALTER USER postgres WITH PASSWORD %s;"
    positional_args:
      - "{{ db_master_password }}"
  environment:
    PGDATA: "{{ pg_data_dir }}"
  no_log: true

- name: Display password set confirmation
  debug:
    msg:
      - "PostgreSQL superuser password has been set from GCP secret"
      - "Secret: postgres-master-pwd-*-{{ _environment }}-{{ _customer | lower }}"
